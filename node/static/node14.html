<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="./js/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet" href="./bootstrap-3.3.7-dist/css/bootstrap.css">
    <script src="./bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
</head>

<body>
    <!-- 添加联系人模态框 -->
    <div class="modal fade" tabindex="-1" role="dialog" id="add-contact-modal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">添加联系人</h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label for="inputname" class="col-sm-2 control-label">姓名</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="inputname" placeholder="name">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="inputphonenumber" class="col-sm-2 control-label">号码</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="inputphonenumber" placeholder="phonenumber">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="add-contact-submit">保存联系人</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    <!-- 修改联系人模态框 -->
    <div class="modal fade" tabindex="-1" role="dialog" id="updata-contact-modal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">修改联系人</h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label for="updataname" class="col-sm-2 control-label">姓名</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="updataname" placeholder="name">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="updataphonenumber" class="col-sm-2 control-label">号码</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="updataphonenumber"
                                    placeholder="phonenumber">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="updata-contact-submit">修改联系人</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->


    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">通讯录</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">

                <form class="navbar-form navbar-left">
                    <div class="form-group">
                        <input type="text" id="search-input" class="form-control" placeholder="Search">
                    </div>
                    <button type="submit" class="btn btn-default">清空搜索</button>
                </form>
                <ul class="nav navbar-nav navbar-right">
                    <li id="add-contact-btn"><a href="javascript:void(0)">添加联系人</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                            aria-expanded="false">Dropdown <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="#">Action</a></li>
                            <li><a href="#">Another action</a></li>
                            <li><a href="#">Something else here</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="#">Separated link</a></li>
                        </ul>
                    </li>
                </ul>
            </div><!-- /.navbar-collapse -->
        </div><!-- /.container-fluid -->
    </nav>
    <div class="container">
        <ul class="list-group" id="contact-list">
            <li class="list-group-item">
                <h3>军少</h3>
                <p>18745291887</p>
                <div class="btn-group" role="group" aria-label="...">
                    <a type="button" class="btn btn-default">拨打联系人号码</a>
                    <button type="button" class="btn btn-default">修改联系人信息</button>
                    <button type="button" class="btn btn-default">删除联系人信息</button>
                </div>
            </li>
            <li class="list-group-item">Dapibus ac facilisis in</li>
            <li class="list-group-item">Morbi leo risus</li>
            <li class="list-group-item">Porta ac consectetur ac</li>
            <li class="list-group-item">Vestibulum at eros</li>
        </ul>
    </div>
</body>
<script>
    var contactlist = $("#contact-list")
    var addcontactbtn = $("#add-contact-btn")
    var addmodal = $("#add-contact-modal")
    var addcontactsubmit = $("#add-contact-submit")
    var addcontactname = $("#inputname")
    var addcontactphonenumber = $("#inputphonenumber")
    var updatamodal = $("#updata-contact-modal")
    var updatacontactsubmit = $("#updata-contact-submit")
    var updatacontactname = $("#updataname")
    var updatacontactphonenumber = $("#updataphonenumber")
    var searchinput=$("#search-input")
    var updataid = ""
    var contact={
        arr:[],
        getcontactbyid:function(_id){
            for(var i=0;i<this.arr.length;i++){
                if(this.arr[i]._id==_id){
                    return this.arr[i]
                }
            }
            return null
        }
    }
    var addlistener = function () {
        var removebtn = $(".remove-btn")
        var updatabtn = $(".updata-btn")
        removebtn.on("click", function () {
            removecontact($(this).attr("data_id"))
        })
        updatabtn.on("click", function () {
            // console.log($(this).attr("data_id"))
            updataid = $(this).attr("data_id")
            updatamodal.modal("show")
            var nowupdata=contact.getcontactbyid(updataid)
            if(nowupdata){
                updatacontactname.val(nowupdata.name)
                updatacontactphonenumber.val(nowupdata.phonenumber)
            }
        })

    }
    var filldata = function (arr) {
        var html = ""
        arr.forEach(item => {
            html += `
            <li class="list-group-item">
                <h3>${item.name}</h3>
                <p>${item.phonenumber}</p>
                <div class="btn-group" role="group" aria-label="...">
                    <a type="button" class="btn btn-default" href="tel:${item.phonenumber}">拨打联系人号码</a>
                    <button type="button" class="btn btn-default updata-btn" data_id="${item._id}">修改联系人信息</button>
                    <button type="button" class="btn btn-default remove-btn" data_id="${item._id}">删除联系人信息</button>
                  </div>
            </li>
            `
        })
        contactlist.html(html)
        addlistener()
    }
    var getallcontact = function () {
        $.ajax({
            type: "GET",
            url: "/getallcontact",
            data: {},
            success: function (result) {
                contact.arr=result
                filldata(result)
            }
        })
    }
    var addcontact = function (name, phonenumber) {
        $.ajax({
            type: "POST",
            url: "/addcontact",
            data: {
                name: name,
                phonenumber: phonenumber
            },
            success: function (result) {
                getallcontact()
            }
        })
    }
    var removecontact = function (_id) {
        $.ajax({
            type: "GET",
            url: "/remove",
            data: {
                _id: _id
            },
            success: function () {
                getallcontact()
            }
        })
    }
    var updatacontact = function (_id, name, phonenumber) {
        $.ajax({
            type: "post",
            url: "/updatecontact",
            data: {
                _id: _id,
                name: name,
                phonenumber: phonenumber
            },
            success: function (result) {
                getallcontact()
            }
        })
    }
    var search=function(wd){
        $.ajax({
            type:"GET",
            url:"/search",
            data:{
                wd:wd
            },
            success:function(result){
                filldata(result)
            }
        })
    }
    var initlistener = function () {
        addcontactbtn.on("click", function () {
            addmodal.modal("show")
        })
        addcontactsubmit.on("click", function () {
            var name = addcontactname.val()
            var phonenumber = addcontactphonenumber.val()
            addcontact(name, phonenumber)
            addmodal.modal("hide")
        })
        updatacontactsubmit.on("click", function () {
            var name = updatacontactname.val()
            updatacontactname.val("")
            var phonenumber = updatacontactphonenumber.val()
            updatacontactphonenumber.val("")
            updatacontact(updataid, name, phonenumber)
            updataid = ""
            updatamodal.modal("hide")
        })
        searchinput.on("input",function(){
            search($(this).val())
        })
    }

    var main = function () {
        getallcontact()
        initlistener()
    }
    main()
</script>

</html>